"use strict";var U=Object.create;var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var G=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},P=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of F(e))!J.call(t,o)&&o!==n&&C(t,o,{get:()=>e[o],enumerable:!(i=R(e,o))||i.enumerable});return t};var M=(t,e,n)=>(n=t!=null?U(_(t)):{},P(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),W=t=>P(C({},"__esModule",{value:!0}),t);var Z={};G(Z,{activate:()=>z,deactivate:()=>K});module.exports=W(Z);var s=M(require("vscode")),L=require("child_process"),D=require("util"),Q=M(require("https")),q=(0,D.promisify)(L.exec),u,h,$=null;function z(t){console.log("Antigravity Quota Watch is now active!");let e=s.window.createOutputChannel("Antigravity Quota");t.subscriptions.push(e),e.appendLine("Extension activated. Starting auto-discovery...");let n=s.commands.registerCommand("ag-quota.refresh",()=>{e.appendLine("Manual refresh triggered."),y(e,!0)});t.subscriptions.push(n);let i=s.commands.registerCommand("ag-quota.showDetails",()=>{E(e)});t.subscriptions.push(i),u=s.window.createStatusBarItem(s.StatusBarAlignment.Right,100),u.command="ag-quota.showDetails",t.subscriptions.push(u),t.subscriptions.push(s.workspace.onDidChangeConfiguration(o=>{o.affectsConfiguration("antigravity")&&(s.window.showInformationMessage("Antigravity Quota Watch configuration changed. reloading..."),T(e))})),T(e)}function T(t){h&&(clearInterval(h),h=void 0);let n=s.workspace.getConfiguration("antigravity").get("pollInterval",120);y(t),h=setInterval(()=>y(t),n*1e3)}function K(){h&&clearInterval(h)}async function H(t){try{let e='ps -ww -eo pid,args | grep "language_server" | grep -v grep',{stdout:n}=await q(e),i=n.split(`
`);for(let o of i)if(o.includes("--csrf_token")&&o.includes("antigravity")){let d=o.trim().split(/\s+/),a=parseInt(d[0],10),r=o.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(a&&r&&r[1])return t.appendLine(`Found Antigravity process: PID=${a}`),{pid:a,csrfToken:r[1]}}}catch(e){t.appendLine(`Error scanning processes: ${e.message}`)}return null}async function V(t,e){try{let n=`lsof -nP -a -iTCP -sTCP:LISTEN -p ${t}`,{stdout:i}=await q(n),o=i.match(/[*\d.:]+:(\d+)\s+\(LISTEN\)/);if(o&&o[1])return parseInt(o[1],10)}catch(n){e.appendLine(`Error finding port for PID ${t}: ${n.message}`)}return null}function b(t,e=10){let n=Math.round(t/100*e),i=e-n;return"\u2588".repeat(n)+"\u2591".repeat(i)}async function E(t){if(!$){s.window.showInformationMessage("No quota data available yet. Waiting for connection..."),y(t,!0);return}let{userStatus:e}=$,n=e.cascadeModelConfigData?.clientModelConfigs||[],i=e.planStatus,o=[];if(i){let a=i.availablePromptCredits,r=i.planInfo.monthlyPromptCredits,c=r>0?a/r*100:0;o.push({label:"$(circuit-board) Global Token Credits",description:`${b(c,15)} ${Math.floor(c)}%`,detail:`${a.toLocaleString()} / ${r.toLocaleString()} credits remaining`}),o.push({kind:s.QuickPickItemKind.Separator,label:"Models"})}let d=n.filter(a=>a.quotaInfo).map(a=>{let r=a.quotaInfo?.remainingFraction??0,c=Math.round(r*100),l="$(check)";return r<.2&&(l="$(warning)"),r===0&&(l="$(error)"),{label:`${l} ${a.label}`,description:`${b(c,10)} ${c}%`,detail:`Reset: ${a.quotaInfo?.resetTime?new Date(a.quotaInfo.resetTime).toLocaleString():"Unknown"}`}});d.length>0?o.push(...d):o.push({label:"No specific model quotas found."}),s.window.showQuickPick(o,{placeHolder:"Antigravity Quota Details",matchOnDescription:!0})}async function y(t,e=!1){let n=s.workspace.getConfiguration("antigravity"),i=n.get("lowQuotaThreshold",20),o=n.get("pollInterval",120);e&&(u.text="$(sync~spin) Checking...",u.show());try{let d=await H(t);if(!d)throw new Error("Antigravity process not found. Is the IDE running?");let a=await V(d.pid,t);if(!a)throw new Error(`Could not find listening port for PID ${d.pid}`);t.appendLine(`Connected to Antigravity on port ${a} details`);let r=await X(a,d.csrfToken);$=r,t.appendLine("API Response received. Parsing quotas...");let c=r.userStatus?.cascadeModelConfigData?.clientModelConfigs||[],l=r.userStatus?.planStatus,m="$(check) Quota OK",I;if(l){let f=l.availablePromptCredits/l.planInfo.monthlyPromptCredits*100;m=`$(circuit-board) ${Math.floor(f)}%`,f<20&&(m=`$(warning) ${Math.floor(f)}%`,I=new s.ThemeColor("statusBarItem.warningBackground"))}else c.filter(g=>(g.quotaInfo?.remainingFraction??1)<.2).length>0&&(m="$(warning) Quota Low",I=new s.ThemeColor("statusBarItem.warningBackground"));u.text=m,u.backgroundColor=I;let S=new Date,A=new Date(S.getTime()+o*1e3),B=S.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),x=A.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=new s.MarkdownString;if(p.isTrusted=!0,p.appendMarkdown(`### \u{1F680} Antigravity Quota

`),l){let f=l.availablePromptCredits,g=l.planInfo.monthlyPromptCredits,v=g>0?f/g*100:0,w=100-v;p.appendMarkdown(`**Global Credits**
`),p.appendCodeblock(`+ Available: ${f.toLocaleString()} (${Math.floor(v)}%)
- Used:      ${Math.floor(w)}%`,"diff"),p.appendMarkdown(`\`${b(v,20)}\`

`)}let k=c.filter(f=>f.quotaInfo);if(k.length>0){p.appendMarkdown(`**Models**
`);let f="";k.forEach(g=>{let v=g.quotaInfo?.remainingFraction??0,w=Math.round(v*100),O=w>20?"+ ":"- ",N=g.label.padEnd(25," ");f+=`${O}${N} [${b(w,10)}] ${w}%
`}),p.appendCodeblock(f,"diff")}p.appendMarkdown(`---
`),p.appendMarkdown(`Last Updated: ${B} | Next Refresh: ~${x}
`),p.appendMarkdown(`$(server) Port: ${a} | $(key) Token: ${d.csrfToken.substring(0,4)}...`),u.tooltip=p,u.show(),e&&E(t)}catch(d){t.appendLine(`Error: ${d.message}`),u.text="$(error) Offline",u.tooltip=`Error: ${d.message}`,u.backgroundColor=new s.ThemeColor("statusBarItem.errorBackground"),u.show(),e&&s.window.showErrorMessage(`Failed: ${d.message}`)}}function X(t,e){return new Promise((n,i)=>{let o=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),d={hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o),"X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,agent:!1,timeout:5e3},a=Q.request(d,r=>{let c="";r.on("data",l=>c+=l),r.on("end",()=>{if(r.statusCode===200)try{n(JSON.parse(c))}catch{let m=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Invalid JSON response: ${m}`))}else{let l=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Status Code: ${r.statusCode}, Body: ${l}`))}})});a.on("error",r=>i(r)),a.on("timeout",()=>{a.destroy(),i(new Error("Timeout"))}),a.write(o),a.end()})}0&&(module.exports={activate,deactivate});
