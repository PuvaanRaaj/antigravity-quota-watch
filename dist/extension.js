"use strict";var O=Object.create;var w=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty;var F=(t,e)=>{for(var n in e)w(t,n,{get:e[n],enumerable:!0})},k=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of N(e))!U.call(t,o)&&o!==n&&w(t,o,{get:()=>e[o],enumerable:!(i=x(e,o))||i.enumerable});return t};var P=(t,e,n)=>(n=t!=null?O(R(t)):{},k(e||!t||!t.__esModule?w(n,"default",{value:t,enumerable:!0}):n,t)),_=t=>k(w({},"__esModule",{value:!0}),t);var H={};F(H,{activate:()=>J,deactivate:()=>G});module.exports=_(H);var r=P(require("vscode")),T=require("child_process"),L=require("util"),D=P(require("https")),Q=(0,L.promisify)(T.exec),u,h,S=null;function J(t){console.log("Antigravity Quota Watch is now active!");let e=r.window.createOutputChannel("Antigravity Quota");t.subscriptions.push(e),e.appendLine("Extension activated. Starting auto-discovery...");let n=r.commands.registerCommand("ag-quota.refresh",()=>{e.appendLine("Manual refresh triggered."),y(e,!0)});t.subscriptions.push(n);let i=r.commands.registerCommand("ag-quota.showDetails",()=>{q(e)});t.subscriptions.push(i),u=r.window.createStatusBarItem(r.StatusBarAlignment.Right,100),u.command="ag-quota.showDetails",t.subscriptions.push(u),t.subscriptions.push(r.workspace.onDidChangeConfiguration(o=>{o.affectsConfiguration("antigravity")&&(r.window.showInformationMessage("Antigravity Quota Watch configuration changed. reloading..."),M(e))})),M(e)}function M(t){h&&(clearInterval(h),h=void 0);let n=r.workspace.getConfiguration("antigravity").get("pollInterval",120);y(t),h=setInterval(()=>y(t),n*1e3)}function G(){h&&clearInterval(h)}async function W(t){try{let e='ps -ww -eo pid,args | grep "language_server" | grep -v grep',{stdout:n}=await Q(e),i=n.split(`
`);for(let o of i)if(o.includes("--csrf_token")&&o.includes("antigravity")){let d=o.trim().split(/\s+/),a=parseInt(d[0],10),s=o.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(a&&s&&s[1])return t.appendLine(`Found Antigravity process: PID=${a}`),{pid:a,csrfToken:s[1]}}}catch(e){t.appendLine(`Error scanning processes: ${e.message}`)}return null}async function z(t,e){try{let n=`lsof -nP -a -iTCP -sTCP:LISTEN -p ${t}`,{stdout:i}=await Q(n),o=i.match(/[*\d.:]+:(\d+)\s+\(LISTEN\)/);if(o&&o[1])return parseInt(o[1],10)}catch(n){e.appendLine(`Error finding port for PID ${t}: ${n.message}`)}return null}function C(t,e=10){let n=Math.round(t/100*e),i=e-n;return"\u2588".repeat(n)+"\u2591".repeat(i)}async function q(t){if(!S){r.window.showInformationMessage("No quota data available yet. Waiting for connection..."),y(t,!0);return}let{userStatus:e}=S,n=e.cascadeModelConfigData?.clientModelConfigs||[],i=e.planStatus,o=[];if(i){let a=i.availablePromptCredits,s=i.planInfo.monthlyPromptCredits,c=s>0?a/s*100:0;o.push({label:"$(circuit-board) Global Token Credits",description:`${C(c,15)} ${Math.floor(c)}%`,detail:`${a.toLocaleString()} / ${s.toLocaleString()} credits remaining`}),o.push({kind:r.QuickPickItemKind.Separator,label:"Models"})}let d=n.filter(a=>a.quotaInfo).map(a=>{let s=a.quotaInfo?.remainingFraction??0,c=Math.round(s*100),l="$(check)";return s<.2&&(l="$(warning)"),s===0&&(l="$(error)"),{label:`${l} ${a.label}`,description:`${C(c,10)} ${c}%`,detail:`Reset: ${a.quotaInfo?.resetTime?new Date(a.quotaInfo.resetTime).toLocaleString():"Unknown"}`}});d.length>0?o.push(...d):o.push({label:"No specific model quotas found."}),r.window.showQuickPick(o,{placeHolder:"Antigravity Quota Details",matchOnDescription:!0})}async function y(t,e=!1){let n=r.workspace.getConfiguration("antigravity"),i=n.get("lowQuotaThreshold",20),o=n.get("pollInterval",120);e&&(u.text="$(sync~spin) Checking...",u.show());try{let d=await W(t);if(!d)throw new Error("Antigravity process not found. Is the IDE running?");let a=await z(d.pid,t);if(!a)throw new Error(`Could not find listening port for PID ${d.pid}`);t.appendLine(`Connected to Antigravity on port ${a} details`);let s=await K(a,d.csrfToken);S=s,t.appendLine("API Response received. Parsing quotas...");let c=s.userStatus?.cascadeModelConfigData?.clientModelConfigs||[],l=s.userStatus?.planStatus,m="$(check) Quota OK",I;if(l){let p=l.availablePromptCredits/l.planInfo.monthlyPromptCredits*100;m=`$(circuit-board) ${Math.floor(p)}%`,p<20&&(m=`$(warning) ${Math.floor(p)}%`,I=new r.ThemeColor("statusBarItem.warningBackground"))}else c.filter(g=>(g.quotaInfo?.remainingFraction??1)<.2).length>0&&(m="$(warning) Quota Low",I=new r.ThemeColor("statusBarItem.warningBackground"));u.text=m,u.backgroundColor=I;let $=new Date,E=new Date($.getTime()+o*1e3),A=$.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),B=E.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),f=new r.MarkdownString;if(f.isTrusted=!0,f.appendMarkdown(`### \u{1F680} Antigravity Quota

`),l){let p=l.availablePromptCredits,g=l.planInfo.monthlyPromptCredits,v=g>0?p/g*100:0;f.appendMarkdown(`**Global Credits:** ${p.toLocaleString()} / ${g.toLocaleString()}

`),f.appendMarkdown(`\`${C(v,20)}\` **${Math.floor(v)}%**

`),f.appendMarkdown(`---
`)}let b=c.filter(p=>p.quotaInfo);b.length>0&&(f.appendMarkdown(`**Models**
`),b.forEach(p=>{let g=p.quotaInfo?.remainingFraction??0,v=Math.round(g*100);f.appendMarkdown(`- **${p.label}**: \`${C(v,10)}\` ${v}%
`)})),f.appendMarkdown(`
---
`),f.appendMarkdown(`Last Updated: ${A} | Next Refresh: ~${B}
`),f.appendMarkdown(`$(server) Port: ${a} | $(key) Token: ${d.csrfToken.substring(0,4)}...`),u.tooltip=f,u.show(),e&&q(t)}catch(d){t.appendLine(`Error: ${d.message}`),u.text="$(error) Offline",u.tooltip=`Error: ${d.message}`,u.backgroundColor=new r.ThemeColor("statusBarItem.errorBackground"),u.show(),e&&r.window.showErrorMessage(`Failed: ${d.message}`)}}function K(t,e){return new Promise((n,i)=>{let o=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),d={hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o),"X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,agent:!1,timeout:5e3},a=D.request(d,s=>{let c="";s.on("data",l=>c+=l),s.on("end",()=>{if(s.statusCode===200)try{n(JSON.parse(c))}catch{let m=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Invalid JSON response: ${m}`))}else{let l=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Status Code: ${s.statusCode}, Body: ${l}`))}})});a.on("error",s=>i(s)),a.on("timeout",()=>{a.destroy(),i(new Error("Timeout"))}),a.write(o),a.end()})}0&&(module.exports={activate,deactivate});
