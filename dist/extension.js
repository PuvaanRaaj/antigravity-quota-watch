"use strict";var B=Object.create;var P=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var F=(e,n)=>{for(var o in n)P(e,o,{get:n[o],enumerable:!0})},L=(e,n,o,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of _(n))!W.call(e,t)&&t!==o&&P(e,t,{get:()=>n[t],enumerable:!(r=U(n,t))||r.enumerable});return e};var T=(e,n,o)=>(o=e!=null?B(R(e)):{},L(n||!e||!e.__esModule?P(o,"default",{value:e,enumerable:!0}):o,e)),J=e=>L(P({},"__esModule",{value:!0}),e);var oe={};F(oe,{activate:()=>G,deactivate:()=>z});module.exports=J(oe);var c=T(require("vscode")),D=require("child_process"),O=require("util"),q=T(require("https")),y=(0,O.promisify)(D.exec),f,w,S=null;function G(e){console.log("Antigravity Quota Watch is now active!");let n=c.window.createOutputChannel("Antigravity Quota");e.subscriptions.push(n),n.appendLine("Extension activated. Starting auto-discovery...");let o=c.commands.registerCommand("ag-quota.refresh",()=>{n.appendLine("Manual refresh triggered."),C(n,!0)});e.subscriptions.push(o);let r=c.commands.registerCommand("ag-quota.showDetails",()=>{Q(n)});e.subscriptions.push(r),f=c.window.createStatusBarItem(c.StatusBarAlignment.Right,100),f.command="ag-quota.showDetails",e.subscriptions.push(f),e.subscriptions.push(c.workspace.onDidChangeConfiguration(t=>{t.affectsConfiguration("antigravity")&&(c.window.showInformationMessage("Antigravity Quota Watch configuration changed. reloading..."),A(n))})),A(n)}function A(e){w&&(clearInterval(w),w=void 0);let o=c.workspace.getConfiguration("antigravity").get("pollInterval",120);C(e),w=setInterval(()=>C(e),o*1e3)}function z(){w&&clearInterval(w)}async function Z(e){return process.platform==="win32"?K(e):H(e)}async function H(e){try{let n='ps -ww -eo pid,args | grep "language_server" | grep -v grep',{stdout:o}=await y(n),r=o.split(`
`);for(let t of r)if(t.includes("--csrf_token")&&t.includes("antigravity")){let i=t.trim().split(/\s+/),s=parseInt(i[0],10),a=t.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(s&&a&&a[1])return e.appendLine(`Found Antigravity process: PID=${s}`),{pid:s,csrfToken:a[1]}}}catch(n){e.appendLine(`Error scanning processes (Unix): ${n.message}`)}return null}async function K(e){let n=await j(e);return n||(e.appendLine("PowerShell method failed, trying wmic fallback..."),V(e))}async function j(e){try{let n=`powershell -NoProfile -Command "Get-CimInstance Win32_Process | Where-Object { $_.CommandLine -like '*language_server*' } | Select-Object ProcessId, CommandLine | ConvertTo-Json"`,{stdout:o}=await y(n);if(!o.trim())return null;let r=JSON.parse(o),t=Array.isArray(r)?r:[r];for(let i of t){let s=i.CommandLine||"";if(s.includes("--csrf_token")&&s.includes("antigravity")){let a=s.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(a)return e.appendLine(`Found Antigravity process (PowerShell): PID=${i.ProcessId}`),{pid:i.ProcessId,csrfToken:a[1]}}}}catch(n){e.appendLine(`PowerShell process scan failed: ${n.message}`)}return null}async function V(e){try{let n=`wmic process where "name like '%language_server%'" get ProcessId,CommandLine /format:list`,{stdout:o}=await y(n),r=o.split(`

`).filter(t=>t.trim());for(let t of r)if(t.includes("--csrf_token")&&t.includes("antigravity")){let i=t.match(/ProcessId=(\d+)/i),s=t.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(i&&s){let a=parseInt(i[1],10);return e.appendLine(`Found Antigravity process (wmic): PID=${a}`),{pid:a,csrfToken:s[1]}}}}catch(n){e.appendLine(`wmic process scan failed: ${n.message}`)}return null}async function X(e,n){return process.platform==="win32"?ee(e,n):Y(e,n)}async function Y(e,n){try{let o=`lsof -nP -a -iTCP -sTCP:LISTEN -p ${e}`,{stdout:r}=await y(o),t=r.match(/[*\d.:]+:(\d+)\s+\(LISTEN\)/);if(t&&t[1])return parseInt(t[1],10)}catch(o){n.appendLine(`Error finding port for PID ${e} (Unix): ${o.message}`)}return null}async function ee(e,n){try{let o=`netstat -ano | findstr /R "LISTENING.*${e}"`,{stdout:r}=await y(o),t=r.split(`
`);for(let i of t){let s=i.trim().split(/\s+/);if(s.length>=5&&s[4]===String(e)){let l=s[1].match(/:(\d+)$/);if(l)return parseInt(l[1],10)}}}catch(o){n.appendLine(`Error finding port for PID ${e} (Windows): ${o.message}`)}return null}function I(e,n=10){let o=Math.round(e/100*n),r=n-o;return"\u2588".repeat(o)+"\u2591".repeat(r)}function ne(e){let n=new Date(e),o=new Date,r=n.getTime()-o.getTime();if(r<=0)return"Now";let t=Math.floor(r/(1e3*60*60)),i=Math.floor(r%(1e3*60*60)/(1e3*60));return`${t}h ${i}m`}async function Q(e){if(!S){c.window.showInformationMessage("No quota data available yet. Waiting for connection..."),C(e,!0);return}let{userStatus:n}=S,o=n.cascadeModelConfigData?.clientModelConfigs||[],r=n.planStatus,t=[];if(r){let s=r.availablePromptCredits,a=r.planInfo.monthlyPromptCredits,l=a>0?s/a*100:0;t.push({label:"$(circuit-board) Global Token Credits",description:`${I(l,15)} ${Math.floor(l)}%`,detail:`${s.toLocaleString()} / ${a.toLocaleString()} credits remaining`}),t.push({kind:c.QuickPickItemKind.Separator,label:"Models"})}let i=o.filter(s=>s.quotaInfo).map(s=>{let a=s.quotaInfo?.remainingFraction??0,l=Math.round(a*100),u="$(check)";return a<.2&&(u="$(warning)"),a===0&&(u="$(error)"),{label:`${u} ${s.label}`,description:`${I(l,10)} ${l}%`,detail:`Reset: ${s.quotaInfo?.resetTime?new Date(s.quotaInfo.resetTime).toLocaleString():"Unknown"}`}});i.length>0?t.push(...i):t.push({label:"No specific model quotas found."}),c.window.showQuickPick(t,{placeHolder:"Antigravity Quota Details",matchOnDescription:!0})}async function C(e,n=!1){let o=c.workspace.getConfiguration("antigravity"),r=o.get("lowQuotaThreshold",20),t=o.get("pollInterval",120);n&&(f.text="$(sync~spin) Checking...",f.show());try{let i=await Z(e);if(!i)throw new Error("Antigravity process not found. Is the IDE running?");let s=await X(i.pid,e);if(!s)throw new Error(`Could not find listening port for PID ${i.pid}`);e.appendLine(`Connected to Antigravity on port ${s} details`);let a=await te(s,i.csrfToken);S=a,e.appendLine("API Response received. Parsing quotas...");let l=a.userStatus?.cascadeModelConfigData?.clientModelConfigs||[],u=a.userStatus?.planStatus,m="$(check) Quota OK",b;if(u){let d=u.availablePromptCredits/u.planInfo.monthlyPromptCredits*100;m=`$(circuit-board) ${Math.floor(d)}%`,d<20&&(m=`$(warning) ${Math.floor(d)}%`,b=new c.ThemeColor("statusBarItem.warningBackground"))}else l.filter(h=>(h.quotaInfo?.remainingFraction??1)<.2).length>0&&(m="$(warning) Quota Low",b=new c.ThemeColor("statusBarItem.warningBackground"));f.text=m,f.backgroundColor=b;let $=new Date,se=new Date($.getTime()+t*1e3),E=$.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=new c.MarkdownString;if(p.isTrusted=!0,p.appendMarkdown(`### \u{1F680} Antigravity Quota

`),u){let d=u.availablePromptCredits,h=u.planInfo.monthlyPromptCredits,g=h>0?d/h*100:0,v=100-g;p.appendMarkdown(`**Global Credits**

`),p.appendMarkdown(`| Available | Used | Balance |
|:--|:--|:--|
`),p.appendMarkdown(`| **${d.toLocaleString()}** | ${Math.floor(v)}% | \`${I(g,15)}\` |

`)}let k=l.filter(d=>d.quotaInfo);k.length>0&&(p.appendMarkdown(`**Models**

`),p.appendMarkdown(`| | Model | Quota | Reset |
|:--|:--|:--|:--|
`),k.forEach(d=>{let h=d.quotaInfo?.remainingFraction??0,g=Math.round(h*100),v="\u{1F7E2}";g<=50&&(v="\u{1F7E1}"),g<=20&&(v="\u{1F534}");let N=I(g,8),M="-";d.quotaInfo?.resetTime&&(M=ne(d.quotaInfo.resetTime));let x=d.label.length>22?d.label.substring(0,20)+"..":d.label;p.appendMarkdown(`| ${v} | ${x} | \`${N}\` ${g}% | ${M} |
`)}),p.appendMarkdown(`
`)),p.appendMarkdown(`---
`),p.appendMarkdown(`Last Updated: ${E}`),f.tooltip=p,f.show(),n&&Q(e)}catch(i){e.appendLine(`Error: ${i.message}`),f.text="$(error) Offline",f.tooltip=`Error: ${i.message}`,f.backgroundColor=new c.ThemeColor("statusBarItem.errorBackground"),f.show(),n&&c.window.showErrorMessage(`Failed: ${i.message}`)}}function te(e,n){return new Promise((o,r)=>{let t=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),i={hostname:"127.0.0.1",port:e,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(t),"X-Codeium-Csrf-Token":n,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,agent:!1,timeout:5e3},s=q.request(i,a=>{let l="";a.on("data",u=>l+=u),a.on("end",()=>{if(a.statusCode===200)try{o(JSON.parse(l))}catch{let m=l.length>200?l.substring(0,200)+"...":l;r(new Error(`Invalid JSON response: ${m}`))}else{let u=l.length>200?l.substring(0,200)+"...":l;r(new Error(`Status Code: ${a.statusCode}, Body: ${u}`))}})});s.on("error",a=>r(a)),s.on("timeout",()=>{s.destroy(),r(new Error("Timeout"))}),s.write(t),s.end()})}0&&(module.exports={activate,deactivate});
