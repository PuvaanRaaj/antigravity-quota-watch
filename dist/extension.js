"use strict";var x=Object.create;var C=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var J=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},P=(t,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of U(e))!_.call(t,o)&&o!==n&&C(t,o,{get:()=>e[o],enumerable:!(a=R(e,o))||a.enumerable});return t};var T=(t,e,n)=>(n=t!=null?x(F(t)):{},P(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),G=t=>P(C({},"__esModule",{value:!0}),t);var Z={};J(Z,{activate:()=>W,deactivate:()=>z});module.exports=G(Z);var s=T(require("vscode")),L=require("child_process"),q=require("util"),Q=T(require("https")),E=(0,q.promisify)(L.exec),f,w,S=null;function W(t){console.log("Antigravity Quota Watch is now active!");let e=s.window.createOutputChannel("Antigravity Quota");t.subscriptions.push(e),e.appendLine("Extension activated. Starting auto-discovery...");let n=s.commands.registerCommand("ag-quota.refresh",()=>{e.appendLine("Manual refresh triggered."),I(e,!0)});t.subscriptions.push(n);let a=s.commands.registerCommand("ag-quota.showDetails",()=>{A(e)});t.subscriptions.push(a),f=s.window.createStatusBarItem(s.StatusBarAlignment.Right,100),f.command="ag-quota.showDetails",t.subscriptions.push(f),t.subscriptions.push(s.workspace.onDidChangeConfiguration(o=>{o.affectsConfiguration("antigravity")&&(s.window.showInformationMessage("Antigravity Quota Watch configuration changed. reloading..."),D(e))})),D(e)}function D(t){w&&(clearInterval(w),w=void 0);let n=s.workspace.getConfiguration("antigravity").get("pollInterval",120);I(t),w=setInterval(()=>I(t),n*1e3)}function z(){w&&clearInterval(w)}async function H(t){try{let e='ps -ww -eo pid,args | grep "language_server" | grep -v grep',{stdout:n}=await E(e),a=n.split(`
`);for(let o of a)if(o.includes("--csrf_token")&&o.includes("antigravity")){let c=o.trim().split(/\s+/),r=parseInt(c[0],10),i=o.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(r&&i&&i[1])return t.appendLine(`Found Antigravity process: PID=${r}`),{pid:r,csrfToken:i[1]}}}catch(e){t.appendLine(`Error scanning processes: ${e.message}`)}return null}async function K(t,e){try{let n=`lsof -nP -a -iTCP -sTCP:LISTEN -p ${t}`,{stdout:a}=await E(n),o=a.match(/[*\d.:]+:(\d+)\s+\(LISTEN\)/);if(o&&o[1])return parseInt(o[1],10)}catch(n){e.appendLine(`Error finding port for PID ${t}: ${n.message}`)}return null}function b(t,e=10){let n=Math.round(t/100*e),a=e-n;return"\u2588".repeat(n)+"\u2591".repeat(a)}function V(t){let e=new Date(t),n=new Date,a=e.getTime()-n.getTime();if(a<=0)return"Now";let o=Math.floor(a/(1e3*60*60)),c=Math.floor(a%(1e3*60*60)/(1e3*60));return`${o}h ${c}m`}async function A(t){if(!S){s.window.showInformationMessage("No quota data available yet. Waiting for connection..."),I(t,!0);return}let{userStatus:e}=S,n=e.cascadeModelConfigData?.clientModelConfigs||[],a=e.planStatus,o=[];if(a){let r=a.availablePromptCredits,i=a.planInfo.monthlyPromptCredits,d=i>0?r/i*100:0;o.push({label:"$(circuit-board) Global Token Credits",description:`${b(d,15)} ${Math.floor(d)}%`,detail:`${r.toLocaleString()} / ${i.toLocaleString()} credits remaining`}),o.push({kind:s.QuickPickItemKind.Separator,label:"Models"})}let c=n.filter(r=>r.quotaInfo).map(r=>{let i=r.quotaInfo?.remainingFraction??0,d=Math.round(i*100),u="$(check)";return i<.2&&(u="$(warning)"),i===0&&(u="$(error)"),{label:`${u} ${r.label}`,description:`${b(d,10)} ${d}%`,detail:`Reset: ${r.quotaInfo?.resetTime?new Date(r.quotaInfo.resetTime).toLocaleString():"Unknown"}`}});c.length>0?o.push(...c):o.push({label:"No specific model quotas found."}),s.window.showQuickPick(o,{placeHolder:"Antigravity Quota Details",matchOnDescription:!0})}async function I(t,e=!1){let n=s.workspace.getConfiguration("antigravity"),a=n.get("lowQuotaThreshold",20),o=n.get("pollInterval",120);e&&(f.text="$(sync~spin) Checking...",f.show());try{let c=await H(t);if(!c)throw new Error("Antigravity process not found. Is the IDE running?");let r=await K(c.pid,t);if(!r)throw new Error(`Could not find listening port for PID ${c.pid}`);t.appendLine(`Connected to Antigravity on port ${r} details`);let i=await X(r,c.csrfToken);S=i,t.appendLine("API Response received. Parsing quotas...");let d=i.userStatus?.cascadeModelConfigData?.clientModelConfigs||[],u=i.userStatus?.planStatus,m="$(check) Quota OK",y;if(u){let l=u.availablePromptCredits/u.planInfo.monthlyPromptCredits*100;m=`$(circuit-board) ${Math.floor(l)}%`,l<20&&(m=`$(warning) ${Math.floor(l)}%`,y=new s.ThemeColor("statusBarItem.warningBackground"))}else d.filter(h=>(h.quotaInfo?.remainingFraction??1)<.2).length>0&&(m="$(warning) Quota Low",y=new s.ThemeColor("statusBarItem.warningBackground"));f.text=m,f.backgroundColor=y;let $=new Date,Y=new Date($.getTime()+o*1e3),B=$.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=new s.MarkdownString;if(p.isTrusted=!0,p.appendMarkdown(`### \u{1F680} Antigravity Quota

`),u){let l=u.availablePromptCredits,h=u.planInfo.monthlyPromptCredits,g=h>0?l/h*100:0,v=100-g;p.appendMarkdown(`**Global Credits**

`),p.appendMarkdown(`| Available | Used | Balance |
|:--|:--|:--|
`),p.appendMarkdown(`| **${l.toLocaleString()}** | ${Math.floor(v)}% | \`${b(g,15)}\` |

`)}let M=d.filter(l=>l.quotaInfo);M.length>0&&(p.appendMarkdown(`**Models**

`),p.appendMarkdown(`| | Model | Quota | Reset |
|:--|:--|:--|:--|
`),M.forEach(l=>{let h=l.quotaInfo?.remainingFraction??0,g=Math.round(h*100),v="\u{1F7E2}";g<=50&&(v="\u{1F7E1}"),g<=20&&(v="\u{1F534}");let O=b(g,8),k="-";l.quotaInfo?.resetTime&&(k=V(l.quotaInfo.resetTime));let N=l.label.length>22?l.label.substring(0,20)+"..":l.label;p.appendMarkdown(`| ${v} | ${N} | \`${O}\` ${g}% | ${k} |
`)}),p.appendMarkdown(`
`)),p.appendMarkdown(`---
`),p.appendMarkdown(`Last Updated: ${B}`),f.tooltip=p,f.show(),e&&A(t)}catch(c){t.appendLine(`Error: ${c.message}`),f.text="$(error) Offline",f.tooltip=`Error: ${c.message}`,f.backgroundColor=new s.ThemeColor("statusBarItem.errorBackground"),f.show(),e&&s.window.showErrorMessage(`Failed: ${c.message}`)}}function X(t,e){return new Promise((n,a)=>{let o=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),c={hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o),"X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,agent:!1,timeout:5e3},r=Q.request(c,i=>{let d="";i.on("data",u=>d+=u),i.on("end",()=>{if(i.statusCode===200)try{n(JSON.parse(d))}catch{let m=d.length>200?d.substring(0,200)+"...":d;a(new Error(`Invalid JSON response: ${m}`))}else{let u=d.length>200?d.substring(0,200)+"...":d;a(new Error(`Status Code: ${i.statusCode}, Body: ${u}`))}})});r.on("error",i=>a(i)),r.on("timeout",()=>{r.destroy(),a(new Error("Timeout"))}),r.write(o),r.end()})}0&&(module.exports={activate,deactivate});
