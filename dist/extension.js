"use strict";var F=Object.create;var C=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var z=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},M=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of J(e))!W.call(t,o)&&o!==n&&C(t,o,{get:()=>e[o],enumerable:!(i=_(e,o))||i.enumerable});return t};var T=(t,e,n)=>(n=t!=null?F(G(t)):{},M(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),K=t=>M(C({},"__esModule",{value:!0}),t);var j={};z(j,{activate:()=>H,deactivate:()=>V});module.exports=K(j);var a=T(require("vscode")),D=require("child_process"),q=require("util"),Q=T(require("https")),E=(0,q.promisify)(D.exec),u,h,y=null;function H(t){console.log("Antigravity Quota Watch is now active!");let e=a.window.createOutputChannel("Antigravity Quota");t.subscriptions.push(e),e.appendLine("Extension activated. Starting auto-discovery...");let n=a.commands.registerCommand("ag-quota.refresh",()=>{e.appendLine("Manual refresh triggered."),I(e,!0)});t.subscriptions.push(n);let i=a.commands.registerCommand("ag-quota.showDetails",()=>{A(e)});t.subscriptions.push(i),u=a.window.createStatusBarItem(a.StatusBarAlignment.Right,100),u.command="ag-quota.showDetails",t.subscriptions.push(u),t.subscriptions.push(a.workspace.onDidChangeConfiguration(o=>{o.affectsConfiguration("antigravity")&&(a.window.showInformationMessage("Antigravity Quota Watch configuration changed. reloading..."),L(e))})),L(e)}function L(t){h&&(clearInterval(h),h=void 0);let n=a.workspace.getConfiguration("antigravity").get("pollInterval",120);I(t),h=setInterval(()=>I(t),n*1e3)}function V(){h&&clearInterval(h)}async function X(t){try{let e='ps -ww -eo pid,args | grep "language_server" | grep -v grep',{stdout:n}=await E(e),i=n.split(`
`);for(let o of i)if(o.includes("--csrf_token")&&o.includes("antigravity")){let d=o.trim().split(/\s+/),s=parseInt(d[0],10),r=o.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/);if(s&&r&&r[1])return t.appendLine(`Found Antigravity process: PID=${s}`),{pid:s,csrfToken:r[1]}}}catch(e){t.appendLine(`Error scanning processes: ${e.message}`)}return null}async function Z(t,e){try{let n=`lsof -nP -a -iTCP -sTCP:LISTEN -p ${t}`,{stdout:i}=await E(n),o=i.match(/[*\d.:]+:(\d+)\s+\(LISTEN\)/);if(o&&o[1])return parseInt(o[1],10)}catch(n){e.appendLine(`Error finding port for PID ${t}: ${n.message}`)}return null}function b(t,e=10){let n=Math.round(t/100*e),i=e-n;return"\u2588".repeat(n)+"\u2591".repeat(i)}async function A(t){if(!y){a.window.showInformationMessage("No quota data available yet. Waiting for connection..."),I(t,!0);return}let{userStatus:e}=y,n=e.cascadeModelConfigData?.clientModelConfigs||[],i=e.planStatus,o=[];if(i){let s=i.availablePromptCredits,r=i.planInfo.monthlyPromptCredits,c=r>0?s/r*100:0;o.push({label:"$(circuit-board) Global Token Credits",description:`${b(c,15)} ${Math.floor(c)}%`,detail:`${s.toLocaleString()} / ${r.toLocaleString()} credits remaining`}),o.push({kind:a.QuickPickItemKind.Separator,label:"Models"})}let d=n.filter(s=>s.quotaInfo).map(s=>{let r=s.quotaInfo?.remainingFraction??0,c=Math.round(r*100),l="$(check)";return r<.2&&(l="$(warning)"),r===0&&(l="$(error)"),{label:`${l} ${s.label}`,description:`${b(c,10)} ${c}%`,detail:`Reset: ${s.quotaInfo?.resetTime?new Date(s.quotaInfo.resetTime).toLocaleString():"Unknown"}`}});d.length>0?o.push(...d):o.push({label:"No specific model quotas found."}),a.window.showQuickPick(o,{placeHolder:"Antigravity Quota Details",matchOnDescription:!0})}async function I(t,e=!1){let n=a.workspace.getConfiguration("antigravity"),i=n.get("lowQuotaThreshold",20),o=n.get("pollInterval",120);e&&(u.text="$(sync~spin) Checking...",u.show());try{let d=await X(t);if(!d)throw new Error("Antigravity process not found. Is the IDE running?");let s=await Z(d.pid,t);if(!s)throw new Error(`Could not find listening port for PID ${d.pid}`);t.appendLine(`Connected to Antigravity on port ${s} details`);let r=await Y(s,d.csrfToken);y=r,t.appendLine("API Response received. Parsing quotas...");let c=r.userStatus?.cascadeModelConfigData?.clientModelConfigs||[],l=r.userStatus?.planStatus,m="$(check) Quota OK",S;if(l){let f=l.availablePromptCredits/l.planInfo.monthlyPromptCredits*100;m=`$(circuit-board) ${Math.floor(f)}%`,f<20&&(m=`$(warning) ${Math.floor(f)}%`,S=new a.ThemeColor("statusBarItem.warningBackground"))}else c.filter(g=>(g.quotaInfo?.remainingFraction??1)<.2).length>0&&(m="$(warning) Quota Low",S=new a.ThemeColor("statusBarItem.warningBackground"));u.text=m,u.backgroundColor=S;let $=new Date,B=new Date($.getTime()+o*1e3),x=$.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),O=B.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=new a.MarkdownString;if(p.isTrusted=!0,p.appendMarkdown(`### \u{1F680} Antigravity Quota

`),l){let f=l.availablePromptCredits,g=l.planInfo.monthlyPromptCredits,v=g>0?f/g*100:0,w=100-v;p.appendMarkdown(`**Global Credits**
`),p.appendCodeblock(`+ Available: ${f.toLocaleString()} (${Math.floor(v)}%)
- Used:      ${Math.floor(w)}%`,"diff"),p.appendMarkdown(`\`${b(v,20)}\`

`)}let P=c.filter(f=>f.quotaInfo);if(P.length>0){p.appendMarkdown(`**Models**
`);let f="";P.forEach(g=>{let v=g.quotaInfo?.remainingFraction??0,w=Math.round(v*100),N=w<=30?"- ":"  ",R=g.label.substring(0,25).padEnd(25," "),U=b(w,10),k="";g.quotaInfo?.resetTime&&(k=` (Resets ${new Date(g.quotaInfo.resetTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})`),f+=`${N}${R} [${U}] ${w}% Remaining${k}
`}),p.appendCodeblock(f,"diff")}p.appendMarkdown(`---
`),p.appendMarkdown(`Last Updated: ${x} | Next Refresh: ~${O}`),u.tooltip=p,u.show(),e&&A(t)}catch(d){t.appendLine(`Error: ${d.message}`),u.text="$(error) Offline",u.tooltip=`Error: ${d.message}`,u.backgroundColor=new a.ThemeColor("statusBarItem.errorBackground"),u.show(),e&&a.window.showErrorMessage(`Failed: ${d.message}`)}}function Y(t,e){return new Promise((n,i)=>{let o=JSON.stringify({metadata:{ideName:"antigravity",extensionName:"antigravity",locale:"en"}}),d={hostname:"127.0.0.1",port:t,path:"/exa.language_server_pb.LanguageServerService/GetUserStatus",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o),"X-Codeium-Csrf-Token":e,"Connect-Protocol-Version":"1"},rejectUnauthorized:!1,agent:!1,timeout:5e3},s=Q.request(d,r=>{let c="";r.on("data",l=>c+=l),r.on("end",()=>{if(r.statusCode===200)try{n(JSON.parse(c))}catch{let m=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Invalid JSON response: ${m}`))}else{let l=c.length>200?c.substring(0,200)+"...":c;i(new Error(`Status Code: ${r.statusCode}, Body: ${l}`))}})});s.on("error",r=>i(r)),s.on("timeout",()=>{s.destroy(),i(new Error("Timeout"))}),s.write(o),s.end()})}0&&(module.exports={activate,deactivate});
